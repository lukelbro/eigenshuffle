import numpy as np
import numpy.typing as npt

from eigenshuffle import eigenshuffle_eig, eigenshuffle_eigh


def test_eigenshuffle_hermitian():
    def eigenvalue_function(
        t: float | npt.NDArray[np.float_],
    ) -> npt.NDArray[np.float_]:
        return np.array(
            [
                [1, 2 * t + 1, t**2, t**3],
                [2 * t + 1, 2 - t, t**2, 1 - t**3],
                [t**2, t**2, 3 - 2 * t, t**2],
                [t**3, 1 - t**3, t**2, 4 - 3 * t],
            ]
        )

    tseq = np.arange(-1, 1.1, 0.1, dtype=np.float64)
    Aseq = np.array([eigenvalue_function(ti) for ti in tseq])

    Dseq, Vseq = eigenshuffle_eigh(Aseq, use_eigenvalues=True)

    Dseq_result = np.array(
        [
            [2.01807787e-01, 2.34468977e00, 5.00000000e00, 8.45350244e00],
            [4.46444425e-01, 2.37278553e00, 4.76869965e00, 7.81207039e00],
            [6.50537693e-01, 2.34131394e00, 4.56000539e00, 7.24814297e00],
            [8.11802506e-01, 2.27094977e00, 4.36481455e00, 6.75243317e00],
            [9.23641655e-01, 2.18568005e00, 4.17511785e00, 6.31556045e00],
            [9.74449526e-01, 2.11183494e00, 3.98546098e00, 5.92825456e00],
            [9.52541286e-01, 2.07267152e00, 3.79314408e00, 5.58164312e00],
            [8.57997539e-01, 2.07681965e00, 3.59759344e00, 5.26758938e00],
            [7.05814192e-01, 2.11560230e00, 3.39948848e00, 4.97909503e00],
            [5.14941574e-01, 2.17419889e00, 3.19996664e00, 4.71089289e00],
            [3.00371852e-01, 2.23912328e00, 3.00000000e00, 4.46050487e00],
            [7.26886695e-02, 2.29713164e00, 2.79996981e00, 4.23020988e00],
            [-1.60340670e-01, 2.33034363e00, 2.59973107e00, 4.03026597e00],
            [-3.92718246e-01, 2.30635749e00, 2.40465559e00, 3.88170517e00],
            [-6.20014444e-01, 2.26280146e00, 2.14640989e00, 3.81080309e00],
            [-8.39923018e-01, 2.11113817e00, 1.89856712e00, 3.83021773e00],
            [-1.05365434e00, 1.92977085e00, 1.59374301e00, 3.93014048e00],
            [-1.26853285e00, 1.74502602e00, 1.23083725e00, 4.09266958e00],
            [-1.50228846e00, 1.57290562e00, 8.25152817e-01, 4.30423003e00],
            [-1.78830615e00, 1.42718321e00, 4.03893140e-01, 4.55722981e00],
            [-2.17554439e00, 1.32732731e00, 1.67320090e-15, 4.84821708e00],
        ]
    )

    Vseq_result = np.array(
        [
            [
                [8.85223372e-01, 3.32003327e-01, -3.01511345e-01, 1.23467738e-01],
                [3.70423332e-01, -8.41059546e-01, -5.55111512e-16, -3.94214910e-01],
                [-2.74534151e-01, 3.13073706e-02, -9.04534034e-01, -3.24759958e-01],
                [6.16209201e-02, 4.25925438e-01, 3.01511345e-01, -8.50812137e-01],
            ],
            [
                [-9.06002863e-01, -3.23969224e-01, 2.53241587e-01, -1.00356627e-01],
                [-3.45821240e-01, 8.60840934e-01, 1.19096729e-02, 3.73120243e-01],
                [2.40566328e-01, -4.92393840e-02, 9.19412129e-01, 3.07220869e-01],
                [-4.11621653e-02, -3.89322889e-01, -3.00679556e-01, 8.69669575e-01],
            ],
            [
                [-2.79236624e00, -8.76278274e-01, 6.16577358e-01, -2.33793807e-01],
                [-9.06571461e-01, 2.65536246e00, 6.97976649e-02, 1.05938977e00],
                [6.12106124e-01, -2.01490887e-01, 2.80578184e00, 8.43988007e-01],
                [-7.83905276e-02, -1.06798316e00, -8.61712764e-01, 2.66659296e00],
            ],
            [
                [-2.87466398e00, -6.87847906e-01, 4.84298858e-01, -1.69194743e-01],
                [-6.98437842e-01, 2.73626047e00, 9.27896004e-02, 1.00819309e00],
                [4.95447379e-01, -2.43555468e-01, 2.85399389e00, 7.41573666e-01],
                [-5.49860214e-02, -9.90163940e-01, -7.82025306e-01, 2.72121082e00],
            ],
            [
                [-2.95067017e00, -3.82992916e-01, 3.67933864e-01, -1.07175844e-01],
                [-3.87546064e-01, 2.80995084e00, 1.00021356e-01, 9.71586359e-01],
                [3.73569601e-01, -2.65422627e-01, 2.89963831e00, 6.18137752e-01],
                [-6.16389889e-02, -9.41829885e-01, -6.68369732e-01, 2.76811109e00],
            ],
            [
                [-2.98726629e00, -1.50885811e-02, 2.68350562e-01, 1.55602148e-02],
                [3.64267145e-02, -9.47427631e-01, 9.21485425e-02, -3.18260847e-01],
                [2.52545536e-01, 8.67096806e-02, 2.93889370e00, -1.60366761e-01],
                [-1.05517489e-01, 3.07627454e-01, -5.31413653e-01, -9.34211119e-01],
            ],
            [
                [-2.94472586e00, 1.80885618e-01, -6.13764998e-02, -1.44724023e-02],
                [5.23846244e-01, 9.30691804e-01, -2.44924809e-02, -9.61509789e-01],
                [1.46206592e-01, -7.43285126e-02, -9.89535158e-01, -3.41002378e-01],
                [-1.81103094e-01, -3.09141443e-01, 1.28270085e-01, -2.82117118e00],
            ],
            [
                [-2.82563134e00, 9.98261872e-01, -1.13693978e-01, -7.97146179e-02],
                [9.69433280e-01, 2.65902364e00, -4.97077234e-02, -9.93640546e-01],
                [6.96806792e-02, -1.59808966e-01, -2.98754316e00, -2.10217952e-01],
                [-2.66741868e-01, -9.52642433e-01, 2.43287302e-01, -2.82172509e00],
            ],
            [
                [-2.67825096e00, 1.34165169e00, -5.69355080e-02, -1.53950865e-01],
                [1.30688718e00, 2.48707093e00, -2.62808866e-02, -1.05158614e00],
                [2.54683523e-02, -8.79906573e-02, -2.99688097e00, -1.01555213e-01],
                [-3.44048045e-01, -1.00334768e00, 1.21540598e-01, -2.80359631e00],
            ],
            [
                [-2.54170096e00, 1.57477073e00, -1.65342188e-02, -2.44090186e-01],
                [1.54051611e00, 2.31034973e00, -7.92850171e-03, -1.13535518e00],
                [5.24858790e-03, -2.72771110e-02, -2.99974593e00, -2.74369127e-02],
                [-4.08091670e-01, -1.08703139e00, 3.44692777e-02, -2.76597827e00],
            ],
            [
                [-2.42913684e00, 1.72327990e00, 4.44089210e-16, -3.60000781e-01],
                [1.69949251e00, 2.13535624e00, 8.88178420e-16, -1.24578446e00],
                [8.32667268e-17, 6.66133815e-16, -3.00000000e00, -6.66133815e-16],
                [-4.59368467e-01, -1.21266652e00, 3.33066907e-16, -2.70525794e00],
            ],
            [
                [-2.34074343e00, 1.80407236e00, -2.58127361e-02, -5.15341462e-01],
                [1.80921484e00, 1.95165031e00, -1.37634549e-02, -1.38477915e00],
                [3.77357223e-03, -4.70297526e-02, -2.99946315e00, -3.15396521e-02],
                [-4.97642043e-01, -1.39074519e00, 4.86318528e-02, -2.61071162e00],
            ],
            [
                [-2.27342192e00, 1.81182265e00, -1.52174714e-01, -7.25047796e-01],
                [1.88684578e00, 1.73911065e00, -9.01478859e-02, -1.55150911e00],
                [1.31482030e-02, -2.87071338e-01, -2.98326547e00, -1.32454986e-01],
                [-5.20761841e-01, -1.61566794e00, 2.62380195e-01, -2.45958957e00],
            ],
            [
                [-2.22417099e00, 1.60393343e00, -7.06520968e-01, -9.90600364e-01],
                [1.94342405e00, 1.41180754e00, -4.87691193e-01, -1.72975712e00],
                [2.59624646e-02, -1.32709202e00, -2.67358132e00, -3.00192660e-01],
                [-5.24873603e-01, -1.63493846e00, 1.05591115e00, -2.22183158e00],
            ],
            [
                [-2.19076706e00, 1.49228227e00, -1.97524445e-01, 4.24590021e-01],
                [1.98606712e00, 1.05891266e00, -2.13728864e-01, 6.25665969e-01],
                [4.02346042e-02, 7.65392513e-01, 9.52251713e-01, 1.67167767e-01],
                [-5.04438590e-01, -2.25077140e00, 9.23078651e-02, 6.32708738e-01],
            ],
            [
                [-2.17152407e00, 1.39975715e00, -2.05539398e-01, 1.51093239e00],
                [2.01930595e00, 9.60419546e-01, -4.21585739e-01, 1.95506093e00],
                [5.31658946e-02, -2.30695513e-01, 2.91087677e00, 6.86111818e-01],
                [-4.51730075e-01, -2.46273300e00, -5.53909269e-01, 1.55694273e00],
            ],
            [
                [-2.16450237e00, 1.22650012e00, 2.45496071e-02, -5.58291320e-01],
                [2.04565692e00, 8.99096028e-01, 1.19139695e-01, -6.56519924e-01],
                [5.98850647e-02, -8.64468701e-01, -9.16394178e-01, -2.77108690e-01],
                [-3.55852532e-01, -2.43721514e00, 3.81345985e-01, -4.24856641e-01],
            ],
            [
                [-2.16577239e00, 1.06417058e00, 9.94784195e-02, -1.77962776e00],
                [2.06543975e00, 9.17408677e-01, 3.16704799e-01, -1.94731046e00],
                [5.16107224e-02, -1.23286882e00, -2.56655047e00, -9.43498533e-01],
                [-2.01804201e-01, -2.34647326e00, 1.51743889e00, -1.07271502e00],
            ],
            [
                [7.21960063e-01, -3.05021092e-01, -8.23668508e-02, 6.15590370e-01],
                [-6.91856080e-01, -3.31694748e-01, -8.36593316e-02, 6.35857590e-01],
                [-4.57044311e-03, 4.64664210e-01, 8.15615314e-01, 3.44728796e-01],
                [-9.37781955e-03, 7.62251861e-01, -5.66558451e-01, 3.12882852e-01],
            ],
            [
                [2.14516827e00, -7.59987140e-01, -4.92315756e-01, 1.89163893e00],
                [-2.06755827e00, -1.11736286e00, -1.39932235e-01, 1.85933376e00],
                [7.21717540e-02, 1.41490763e00, 2.39962664e00, 1.11113438e00],
                [-3.43870861e-01, 2.27419352e00, -1.72622019e00, 8.54377260e-01],
            ],
            [
                [-6.92537806e-01, 1.94546159e-01, -8.01783726e-01, -6.41182196e-01],
                [6.76495638e-01, 4.24283525e-01, -5.41233725e-16, -6.01944467e-01],
                [-7.06285104e-02, -4.44758891e-01, 2.40535118e00, -3.92866389e-01],
                [2.40326137e-01, -7.64411415e-01, -1.60356745e00, -2.68708486e-01],
            ],
        ]
    )

    assert np.allclose(Dseq, Dseq_result)
    assert np.allclose(Vseq, Vseq_result)


def test_eigenshuffle():
    def eigenvalue_function(
        t: float,
    ) -> npt.NDArray[np.float_]:
        return np.array(
            [
                [1, 2 * t + 1, t**2, t**3],
                [2 * t + 1, 2 - t, t**2, 1 - t**3],
                [t**2, t**2, 3 - 2 * t, t**2],
                [t**3, 1 - t**3, t**2, 4 - 3 * t],
            ]
        )

    tseq = np.arange(-1, 1.1, 0.1, dtype=np.float64)
    Aseq = np.array([eigenvalue_function(ti) for ti in tseq])

    Dseq, Vseq = eigenshuffle_eig(Aseq, use_eigenvalues=True)

    Dseq_result = np.array(
        [
            [2.01807787e-01, 2.34468977e00, 5.00000000e00, 8.45350244e00],
            [4.46444425e-01, 2.37278553e00, 4.76869965e00, 7.81207039e00],
            [6.50537693e-01, 2.34131394e00, 4.56000539e00, 7.24814297e00],
            [8.11802506e-01, 2.27094977e00, 4.36481455e00, 6.75243317e00],
            [9.23641655e-01, 2.18568005e00, 4.17511785e00, 6.31556045e00],
            [9.74449526e-01, 2.11183494e00, 3.98546098e00, 5.92825456e00],
            [9.52541286e-01, 2.07267152e00, 3.79314408e00, 5.58164312e00],
            [8.57997539e-01, 2.07681965e00, 3.59759344e00, 5.26758938e00],
            [7.05814192e-01, 2.11560230e00, 3.39948848e00, 4.97909503e00],
            [5.14941574e-01, 2.17419889e00, 3.19996664e00, 4.71089289e00],
            [3.00371852e-01, 2.23912328e00, 3.00000000e00, 4.46050487e00],
            [7.26886695e-02, 2.29713164e00, 2.79996981e00, 4.23020988e00],
            [-1.60340670e-01, 2.33034363e00, 2.59973107e00, 4.03026597e00],
            [-3.92718246e-01, 2.30635749e00, 2.40465559e00, 3.88170517e00],
            [-6.20014444e-01, 2.26280146e00, 2.14640989e00, 3.81080309e00],
            [-8.39923018e-01, 2.11113817e00, 1.89856712e00, 3.83021773e00],
            [-1.05365434e00, 1.92977085e00, 1.59374301e00, 3.93014048e00],
            [-1.26853285e00, 1.74502602e00, 1.23083725e00, 4.09266958e00],
            [-1.50228846e00, 1.57290562e00, 8.25152817e-01, 4.30423003e00],
            [-1.78830615e00, 1.42718321e00, 4.03893140e-01, 4.55722981e00],
            [-2.17554439e00, 1.32732731e00, 1.58912173e-15, 4.84821708e00],
        ]
    )

    Vseq_result = np.array(
        [
            [
                [8.85223372e-01, 3.32003327e-01, 3.01511345e-01, -1.23467738e-01],
                [3.70423332e-01, -8.41059546e-01, 1.00072870e-16, 3.94214910e-01],
                [-2.74534151e-01, 3.13073706e-02, 9.04534034e-01, 3.24759958e-01],
                [6.16209201e-02, 4.25925438e-01, -3.01511345e-01, 8.50812137e-01],
            ],
            [
                [-9.06002863e-01, -3.23969224e-01, -2.53241587e-01, 1.00356627e-01],
                [-3.45821240e-01, 8.60840934e-01, -1.19096729e-02, -3.73120243e-01],
                [2.40566328e-01, -4.92393840e-02, -9.19412129e-01, -3.07220869e-01],
                [-4.11621653e-02, -3.89322889e-01, 3.00679556e-01, -8.69669575e-01],
            ],
            [
                [-2.79236624e00, -8.76278274e-01, -6.16577358e-01, 2.33793807e-01],
                [-9.06571461e-01, 2.65536246e00, -6.97976649e-02, -1.05938977e00],
                [6.12106124e-01, -2.01490887e-01, -2.80578184e00, -8.43988007e-01],
                [-7.83905276e-02, -1.06798316e00, 8.61712764e-01, -2.66659296e00],
            ],
            [
                [-2.87466398e00, -6.87847906e-01, -4.84298858e-01, 1.69194743e-01],
                [-6.98437842e-01, 2.73626047e00, -9.27896004e-02, -1.00819309e00],
                [4.95447379e-01, -2.43555468e-01, -2.85399389e00, -7.41573666e-01],
                [-5.49860214e-02, -9.90163940e-01, 7.82025306e-01, -2.72121082e00],
            ],
            [
                [-2.95067017e00, -3.82992916e-01, -3.67933864e-01, 1.07175844e-01],
                [-3.87546064e-01, 2.80995084e00, -1.00021356e-01, -9.71586359e-01],
                [3.73569601e-01, -2.65422627e-01, -2.89963831e00, -6.18137752e-01],
                [-6.16389889e-02, -9.41829885e-01, 6.68369732e-01, -2.76811109e00],
            ],
            [
                [-2.98726629e00, 4.52657432e-02, 8.94501872e-02, -1.55602148e-02],
                [3.64267145e-02, 2.84228289e00, 3.07161808e-02, 3.18260847e-01],
                [2.52545536e-01, -2.60129042e-01, 9.79631232e-01, 1.60366761e-01],
                [-1.05517489e-01, -9.22882362e-01, -1.77137884e-01, 9.34211119e-01],
            ],
            [
                [9.81575288e-01, -1.80885618e-01, 1.84129499e-01, -4.82413411e-03],
                [-1.74615415e-01, -9.30691804e-01, 7.34774427e-02, -3.20503263e-01],
                [-4.87355307e-02, 7.43285126e-02, 2.96860547e00, -1.13667459e-01],
                [6.03676979e-02, 3.09141443e-01, -3.84810255e-01, -9.40390395e-01],
            ],
            [
                [-9.41877115e-01, 3.32753957e-01, 1.13693978e-01, -7.97146179e-02],
                [3.23144427e-01, 8.86341214e-01, 4.97077234e-02, -9.93640546e-01],
                [2.32268931e-02, -5.32696553e-02, 2.98754316e00, -2.10217952e-01],
                [-8.89139559e-02, -3.17547478e-01, -2.43287302e-01, -2.82172509e00],
            ],
            [
                [8.92750321e-01, -4.47217231e-01, 5.69355080e-02, 5.13169549e-02],
                [-4.35629059e-01, -8.29023644e-01, 2.62808866e-02, 3.50528712e-01],
                [-8.48945075e-03, 2.93302191e-02, 2.99688097e00, 3.38517377e-02],
                [1.14682682e-01, 3.34449225e-01, -1.21540598e-01, 9.34532103e-01],
            ],
            [
                [2.54170096e00, -1.57477073e00, 1.65342188e-02, -8.13633952e-02],
                [-1.54051611e00, -2.31034973e00, 7.92850171e-03, -3.78451727e-01],
                [-5.24858790e-03, 2.72771110e-02, 2.99974593e00, -9.14563757e-03],
                [4.08091670e-01, 1.08703139e00, -3.44692777e-02, -9.21992758e-01],
            ],
            [
                [2.42913684e00, -1.72327990e00, -0.00000000e00, 1.20000260e-01],
                [-1.69949251e00, -2.13535624e00, -1.47911420e-31, 4.15261485e-01],
                [-8.37914501e-32, -1.05281191e-31, 3.00000000e00, 2.04739720e-32],
                [4.59368467e-01, 1.21266652e00, 8.09640802e-79, 9.01752647e-01],
            ],
            [
                [2.34074343e00, -1.80407236e00, 2.58127361e-02, -1.71780487e-01],
                [-1.80921484e00, -1.95165031e00, 1.37634549e-02, -4.61593049e-01],
                [-3.77357223e-03, 4.70297526e-02, 2.99946315e00, -1.05132174e-02],
                [4.97642043e-01, 1.39074519e00, -4.86318528e-02, -8.70237205e-01],
            ],
            [
                [-7.57807308e-01, -1.81182265e00, 1.52174714e-01, 2.41682599e-01],
                [6.28948592e-01, -1.73911065e00, 9.01478859e-02, 5.17169702e-01],
                [4.38273435e-03, 2.87071338e-01, 2.98326547e00, 4.41516619e-02],
                [-1.73587280e-01, 1.61566794e00, -2.62380195e-01, 8.19863191e-01],
            ],
            [
                [-2.22417099e00, -1.60393343e00, 7.06520968e-01, 9.90600364e-01],
                [1.94342405e00, -1.41180754e00, 4.87691193e-01, 1.72975712e00],
                [2.59624646e-02, 1.32709202e00, 2.67358132e00, 3.00192660e-01],
                [-5.24873603e-01, 1.63493846e00, -1.05591115e00, 2.22183158e00],
            ],
            [
                [-2.19076706e00, -1.49228227e00, -5.92573336e-01, 1.27377006e00],
                [1.98606712e00, -1.05891266e00, -6.41186593e-01, 1.87699791e00],
                [4.02346042e-02, -7.65392513e-01, 2.85675514e00, 5.01503301e-01],
                [-5.04438590e-01, 2.25077140e00, 2.76923595e-01, 1.89812621e00],
            ],
            [
                [-2.17152407e00, -1.39975715e00, -2.05539398e-01, 1.51093239e00],
                [2.01930595e00, -9.60419546e-01, -4.21585739e-01, 1.95506093e00],
                [5.31658946e-02, 2.30695513e-01, 2.91087677e00, 6.86111818e-01],
                [-4.51730075e-01, 2.46273300e00, -5.53909269e-01, 1.55694273e00],
            ],
            [
                [-2.16450237e00, -1.22650012e00, -7.36488212e-02, 1.67487396e00],
                [2.04565692e00, -8.99096028e-01, -3.57419085e-01, 1.96955977e00],
                [5.98850647e-02, 8.64468701e-01, 2.74918253e00, 8.31326070e-01],
                [-3.55852532e-01, 2.43721514e00, -1.14403795e00, 1.27456992e00],
            ],
            [
                [-2.16577239e00, -1.06417058e00, -9.94784195e-02, 1.77962776e00],
                [2.06543975e00, -9.17408677e-01, -3.16704799e-01, 1.94731046e00],
                [5.16107224e-02, 1.23286882e00, 2.56655047e00, 9.43498533e-01],
                [-2.01804201e-01, 2.34647326e00, -1.51743889e00, 1.07271502e00],
            ],
            [
                [-2.16588019e00, -9.15063275e-01, -2.47100552e-01, -6.15590370e-01],
                [2.07556824e00, -9.95084244e-01, -2.50977995e-01, -6.35857590e-01],
                [1.37113293e-02, 1.39399263e00, 2.44684594e00, -3.44728796e-01],
                [2.81334586e-02, 2.28675558e00, -1.69967535e00, -3.12882852e-01],
            ],
            [
                [-2.14516827e00, -7.59987140e-01, -4.92315756e-01, -1.89163893e00],
                [2.06755827e00, -1.11736286e00, -1.39932235e-01, -1.85933376e00],
                [-7.21717540e-02, 1.41490763e00, 2.39962664e00, -1.11113438e00],
                [3.43870861e-01, 2.27419352e00, -1.72622019e00, -8.54377260e-01],
            ],
            [
                [-2.07761342e00, 1.94546159e-01, -8.01783726e-01, -1.92354659e00],
                [2.02948692e00, 4.24283525e-01, -7.89836432e-16, -1.80583340e00],
                [-2.11885531e-01, -4.44758891e-01, 2.40535118e00, -1.17859917e00],
                [7.20978412e-01, -7.64411415e-01, -1.60356745e00, -8.06125458e-01],
            ],
        ]
    )

    assert np.allclose(Dseq, Dseq_result)
    assert np.allclose(Vseq, Vseq_result)
